
name: Build with Zero CRC Module.symvers

on: 
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu libelf-dev bc bison flex libssl-dev
    
    - name: Download kernel
      run: |
        git clone --depth=1 --branch android12-5.10-lts \
          https://android.googlesource.com/kernel/common kernel
    
    - name: Configure kernel
      run: |
        cd kernel
        sed -i 's/^SUBLEVEL = .*/SUBLEVEL = 136/' Makefile
        sed -i 's|^EXTRAVERSION =.*|EXTRAVERSION = -android12-9-00020-gc9f59ef34367-ab9585114|' Makefile
        echo "" > .scmversion
        
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- gki_defconfig
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules_prepare -j$(nproc)
    
    - name: Create zero-CRC Module.symvers
      run: |
        cd kernel
        
        # Создаём Module.symvers с НУЛЕВЫМИ CRC (как на устройстве)
        cat > Module.symvers << 'EOF'
0x00000000\tmodule_layout\tvmlinux\tEXPORT_SYMBOL
0x00000000\t__stack_chk_fail\tvmlinux\tEXPORT_SYMBOL
0x00000000\t__stack_chk_guard\tvmlinux\tEXPORT_SYMBOL
0x00000000\tkmalloc_caches\tvmlinux\tEXPORT_SYMBOL
0x00000000\tkmem_cache_alloc_trace\tvmlinux\tEXPORT_SYMBOL
0x00000000\tkfree\tvmlinux\tEXPORT_SYMBOL
0x00000000\t__alloc_pages_nodemask\tvmlinux\tEXPORT_SYMBOL
0x00000000\t__free_pages\tvmlinux\tEXPORT_SYMBOL
0x00000000\tget_user_pages_remote\tvmlinux\tEXPORT_SYMBOL
0x00000000\tfind_vma\tvmlinux\tEXPORT_SYMBOL
0x00000000\taccess_process_vm\tvmlinux\tEXPORT_SYMBOL
0x00000000\t_raw_spin_lock\tvmlinux\tEXPORT_SYMBOL
0x00000000\t_raw_spin_unlock\tvmlinux\tEXPORT_SYMBOL
0x00000000\tprintk\tvmlinux\tEXPORT_SYMBOL
0x00000000\t__class_create\tvmlinux\tEXPORT_SYMBOL
0x00000000\tclass_destroy\tvmlinux\tEXPORT_SYMBOL
0x00000000\tdevice_create\tvmlinux\tEXPORT_SYMBOL
0x00000000\tdevice_destroy\tvmlinux\tEXPORT_SYMBOL
0x00000000\tcdev_init\tvmlinux\tEXPORT_SYMBOL
0x00000000\tcdev_add\tvmlinux\tEXPORT_SYMBOL
0x00000000\tcdev_del\tvmlinux\tEXPORT_SYMBOL
0x00000000\talloc_chrdev_region\tvmlinux\tEXPORT_SYMBOL
0x00000000\tunregister_chrdev_region\tvmlinux\tEXPORT_SYMBOL
0x00000000\tcurrent_task\tvmlinux\tEXPORT_SYMBOL
0x00000000\tfind_vpid\tvmlinux\tEXPORT_SYMBOL
0x00000000\tpid_task\tvmlinux\tEXPORT_SYMBOL
0x00000000\tcopy_from_user\tvmlinux\tEXPORT_SYMBOL
0x00000000\tcopy_to_user\tvmlinux\tEXPORT_SYMBOL
0x00000000\t_copy_from_user\tvmlinux\tEXPORT_SYMBOL
0x00000000\t_copy_to_user\tvmlinux\tEXPORT_SYMBOL
EOF
        
        echo "=== Zero-CRC Module.symvers created ==="
        cat Module.symvers
    
    - name: Build module
      run: |
        KERNEL_DIR=$(pwd)/kernel
        MODULE_SRC=$(pwd)
        
        cd "$KERNEL_DIR"
        make -C "$KERNEL_DIR" M="$MODULE_SRC" \
          ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- \
          KBUILD_MODPOST_WARN=1 \
          modules -j$(nproc)
        
        aarch64-linux-gnu-strip --strip-debug "$MODULE_SRC"/*.ko
    
    - name: Verify
      run: |
        echo "=== Module info ==="
        modinfo *.ko
        
        echo ""
        echo "=== Check __versions section ==="
        readelf -S *.ko | grep __versions || echo "No __versions section (good!)"
        
        echo ""
        echo "=== Strings check ==="
        strings *.ko | grep "module_layout" || echo "No CRC strings"
    
    - uses: actions/upload-artifact@v4
      with:
        name: rt-driver-zero-crc
        path: "*.ko"
