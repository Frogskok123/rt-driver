
name: Build RT Driver for Nubia Z40S Pro (plato)

on: 
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-aarch64-linux-gnu \
          libelf-dev bc bison flex libssl-dev
    
    - name: Download kernel
      run: |
        git clone --depth=1 \
          --branch android12-5.10-lts \
          https://android.googlesource.com/kernel/common kernel
        
        cd kernel
        echo "=== Current commit ==="
        git log -1 --oneline
    
    - name: Configure exact kernel version
      run: |
        cd kernel
        
        # Устанавливаем версию
        sed -i 's/^SUBLEVEL = .*/SUBLEVEL = 136/' Makefile
        sed -i 's|^EXTRAVERSION =.*|EXTRAVERSION = -android12-9-00020-gc9f59ef34367-ab9585114|' Makefile
        echo "" > .scmversion
        
        echo "=== Kernel version ==="
        make kernelversion
    
    - name: Configure and prepare kernel
      run: |
        cd kernel
        
        # GKI config
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- gki_defconfig
        
        # ИСПРАВЛЕНО: Собираем Module.symvers правильно
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- \
          modules_prepare -j$(nproc)
        
        # Если Module.symvers всё ещё нет, создаём пустой
        if [ ! -f Module.symvers ]; then
          echo "⚠️  Module.symvers not found, creating empty file"
          touch Module.symvers
        fi
        
        echo "=== Module.symvers check ==="
        ls -lh Module.symvers
        wc -l Module.symvers
        head -5 Module.symvers || echo "File is empty"
    
    - name: Build rt-driver module
      run: |
        cd kernel
        
        # Собираем модуль
        make -C $(pwd) M=$(pwd)/../rt-driver \
          ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- \
          modules -j$(nproc)
        
        # Strip
        aarch64-linux-gnu-strip --strip-debug ../rt-driver/rt-driver.ko
        
        echo "=== Build complete ==="
        ls -lh ../rt-driver/rt-driver.ko
    
    - name: Verify module
      run: |
        echo "=== Module info ==="
        file rt-driver/rt-driver.ko
        ls -lh rt-driver/rt-driver.ko
        
        echo ""
        echo "=== Full modinfo ==="
        modinfo rt-driver/rt-driver.ko
        
        echo ""
        echo "=== Vermagic check ==="
        MODULE_VER=$(modinfo rt-driver/rt-driver.ko | grep "vermagic:" | sed 's/vermagic: *//')
        DEVICE_VER="5.10.136-android12-9-00020-gc9f59ef34367-ab9585114 SMP preempt mod_unload modversions aarch64"
        
        echo "Module  : $MODULE_VER"
        echo "Device  : $DEVICE_VER"
        
        if [ "$MODULE_VER" = "$DEVICE_VER" ]; then
          echo ""
          echo "✅✅✅ SUCCESS: Vermagic matches exactly! ✅✅✅"
        else
          echo ""
          echo "⚠️  WARNING: Vermagic differs:"
          echo "   Module  : '$MODULE_VER'"
          echo "   Expected: '$DEVICE_VER'"
          echo ""
          echo "Difference:"
          diff -u <(echo "$DEVICE_VER") <(echo "$MODULE_VER") || true
        fi
    
    - name: Upload module
      uses: actions/upload-artifact@v4
      with:
        name: rt-driver-plato
        path: rt-driver/rt-driver.ko
