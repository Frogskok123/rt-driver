name: Build RT Driver (FINAL FIX)

on: 
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu libelf-dev bc bison flex libssl-dev
    
    - name: Download kernel
      run: |
        git clone --depth=1 --branch android12-5.10-lts \
          https://android.googlesource.com/kernel/common kernel
    
    - name: Configure kernel WITHOUT MODVERSIONS
      run: |
        cd kernel
        
        # Версия
        sed -i 's/^SUBLEVEL = .*/SUBLEVEL = 136/' Makefile
        sed -i 's|^EXTRAVERSION =.*|EXTRAVERSION = -android12-9-00020-gc9f59ef34367-ab9585114|' Makefile
        echo "" > .scmversion
        
        # GKI config
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- gki_defconfig
        
        # КРИТИЧНО: Отключаем MODVERSIONS через scripts/config
        ./scripts/config --disable CONFIG_MODVERSIONS
        ./scripts/config --disable CONFIG_ASM_MODVERSIONS
        ./scripts/config --disable CONFIG_MODULE_SRCVERSION_ALL
        
        # Применяем изменения
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        
        echo "=== MODVERSIONS check ==="
        grep -E "CONFIG_MODVERSIONS|CONFIG_ASM_MODVERSIONS" .config || echo "MODVERSIONS disabled!"
        
        # Prepare
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules_prepare -j$(nproc)
    
    - name: Build module
      run: |
        KERNEL_DIR=$(pwd)/kernel
        MODULE_SRC=$(pwd)
        
        cd "$KERNEL_DIR"
        make -C "$KERNEL_DIR" M="$MODULE_SRC" \
          ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- \
          modules -j$(nproc)
        
        aarch64-linux-gnu-strip --strip-debug "$MODULE_SRC"/*.ko
    
    - name: Verify NO MODVERSIONS
      run: |
        echo "=== Module info ==="
        modinfo *.ko
        
        echo ""
        echo "=== Vermagic check (should NOT contain 'modversions') ==="
        VERMAGIC=$(modinfo *.ko | grep vermagic)
        echo "$VERMAGIC"
        
        if echo "$VERMAGIC" | grep -q "modversions"; then
          echo "❌ ERROR: Module still has modversions flag!"
          exit 1
        else
          echo "✅ SUCCESS: Module compiled WITHOUT modversions!"
        fi
    
    - uses: actions/upload-artifact@v4
      with:
        name: rt-driver-no-modversions
        path: "*.ko"
